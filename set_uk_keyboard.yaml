---
- name: Set Universal Locale & Keyboard to UK
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # ==============================================================================
    # 1. DEBIAN / UBUNTU / KALI
    # ==============================================================================
    - name: Handle Debian/Ubuntu Family
      when: ansible_os_family == "Debian"
      block:
        - name: Ensure 'console-setup' and locales are installed
          ansible.builtin.apt:
            name: 
              - console-setup
              - locales
            state: present
            update_cache: yes
            cache_valid_time: 3600

        - name: Generate en_GB.UTF-8 locale
          ansible.builtin.locale_gen:
            name: en_GB.UTF-8
            state: present

        - name: Set Keyboard Layout (XKBLAYOUT) to gb
          ansible.builtin.lineinfile:
            path: /etc/default/keyboard
            regexp: '^XKBLAYOUT='
            line: 'XKBLAYOUT="gb"'
            create: yes
            mode: '0644'
          notify: Refresh Debian Console

    # ==============================================================================
    # 2. REDHAT / ROCKY / SUSE
    # ==============================================================================
    - name: Handle RedHat/Suse Family
      when: ansible_os_family == "RedHat" or ansible_os_family == "Suse"
      block:
        - name: Ensure English language packs are installed
          ansible.builtin.dnf:
            name: langpacks-en
            state: present
          ignore_errors: true 

        # 1. Set System Language (Locale)
        - name: Set System Locale to British English (en_GB)
          ansible.builtin.command: localectl set-locale LANG=en_GB.utf8
          changed_when: false

        # 2. Set Text Console (VC) Keyboard
        # 'uk' is the legacy map name often used for the virtual console
        - name: Set Console (VC) Keyboard to UK
          ansible.builtin.command: localectl set-keymap uk
          changed_when: false

        # 3. Set GUI (X11) Keyboard - THIS FIXES THE GUI ISSUE
        # 'gb' is the correct X11 layout code for the UK
        - name: Set GUI (X11) Keyboard to GB
          ansible.builtin.command: localectl set-x11-keymap gb
          changed_when: false

  # ==============================================================================
  # HANDLERS
  # ==============================================================================
  handlers:
    - name: Refresh Debian Console
      ansible.builtin.command: setupcon
      ignore_errors: true